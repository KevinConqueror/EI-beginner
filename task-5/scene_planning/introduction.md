# 家庭环境中的大模型具身决策系统

## 项目概述

本项目开发了一个基于大语言模型（LLM）的具身决策系统，旨在使机器人能够在家庭环境中自主执行复杂任务。系统结合了Habitat-Sim仿真环境和partnr-planner框架，利用LLM进行高层任务规划，并通过WorldGraph接口管理世界状态。

## 核心功能

- **任务规划**：支持多种Planner类型（LLM-based, oracle, random等）
- **环境仿真**：提供视觉与物理仿真支持
- **多智能体协作**：支持centralized/decentralized模式
- **可扩展工具系统**：包括motor skills和perception tools
- **结构化世界表示**：通过WorldGraph实现对环境的状态管理

## 技术架构

系统采用模块化设计，主要组件包括：
- **Runner**：环境初始化与任务执行
- **Planner**：任务级决策逻辑
- **LLM Server**：vLLM部署的大模型后端
- **Hydra Config System**：统一配置管理

## 应用场景

适用于智能家居、服务机器人等需要复杂任务规划的场景，能够处理物品重排、导航、开关操作等家务任务。

## 1. 项目介绍
一个名为Spot的四足带臂机器人在家庭场景中作业。屋子内中摆放着许多家具（如橱柜、冰箱）和物品（如水果、厨具）。Spot的任务是根据用户的指令执行家务劳动。它需要找到用户指定的多个物品，并通过抓取、放置、移动、开关门、开启关闭、倒入及擦拭等一系列行为，将所有目标物品成功整理到指定状态。例如，用户需要机器人将水壶从柜子中取出，然后接满水，接上电源进行加热，再整理好桌面等。这类任务在机器人决策规划领域被称为“任务规划”（Task Planning），是具身智能的核心研究问题之一。

## 2. 场景表示
机器人将以世界图（World Graph）的形式认知家庭场景的状态。世界图是对室内环境的一种结构化表达。它将场景中的实体与空间元素（如机器人、物体、家具、区域等）作为图的节点（Node）。连接节点的边（Edge）则表示实体、区域之间的空间几何关系（如从属关系、邻接关系、包含关系等）。机器人可以基于世界图进行任务理解与决策规划。本题目中使用的世界图设计如下：

### 2.1 节点 (Node)

#### 2.1.1 节点类型 (Node Type)
屋子内共有7种节点：
1. House Node: 这是场景图的根节点，代表整个房屋空间。
2. Region Node: 这是场景图的区域节点，是房屋（House）节点的子节点，如客厅、厨房、卧室等。
3. Furniture Node: 这是场景图的家具节点，是区域（Region）节点的子节点，如沙发、柜子、抽屉等。
4. Receptacle Node: 这是场景图的可操作区域节点，是家具（Furniture）节点的子节点，代表家具上/内的可以摆放物品的子空间区域。
5. Object Node: 这是场景图的物体节点，是可操作区域（Receptacle）节点的子节点，物品静置时，它是其所在可操作区域（Receptacle）的子节点；被机器人抓取时，它是机器人（Agent）的子节点。
6. Agent Node：代表在屋内作业的机器人/人，是所处家具（Furniture）的子节点。机器人可以在不同的位置间移动，并对区域节点下的家具和物品进行操作。

#### 2.1.2 节点属性 (Node Properties)
节点的属性（Properties）决定了它能被什么样的技能操作，房间中家具和物体节点具有属性。
**注意：物体不一定具有所有以下属性！**
**家具节点**
1. Open (Boolean)： 描述家具开关状态的布尔值，比如打开后可以再关闭。
2. Clean (Boolean): 描述家具干净状态的布尔值，在擦拭之后不会再变脏。

**物体节点**
1. Clean (Boolean): 描述物体干净状态的布尔值，在擦拭之后不会再变脏。
2. On/Off (Boolean): 描述物体开关状态的布尔值，电器在打开之后可以再关闭。
3. Fill (Boolean): 描述物体填充状态的布尔值，比如水壶在添水后可以再倒水。

### 2.2 边 (Edge)

#### 2.2.1 从属关系
空间上一个节点在 (In) 另一个节点内的关系，反之亦然 (Has)。有这类边关系的节点对有
1. 房屋 --Has--> 区域，区域 --In--> 房屋
1. 区域 --Has--> 家具，家具 --In--> 区域
2. 区域 --Has--> 机器人，机器人 --In--> 区域
#### 2.2.2 相邻关系
空间上一个节点在 (Next To)另一个节点旁的关系，反之亦然 (Next To)。有这类边关系的节点对有
1. 物体 <--Next to--> 物体

#### 2.2.3 上下关系
空间上一个节点在 (On)另一个节点之上的关系，反之亦然 (Under)。有这类边关系的节点对有
1. 物体 --On--> 可操作区域，可操作区域 --Under--> 物体
2. 可操作区域 --On--> 家具, 家具 --Under--> 可操作区域

#### 2.2.4 内外关系
空间上一个节点在 (Inside)另一个节点之内的关系，反之亦然 (contains)。有这类边关系的节点对有
1. 可操作区域 --Inside--> 家具, 家具 --Contains--> 可操作区域

## 3. 任务设定细节

### 3.1任务目标
每个任务会以语言指令的方式，比如使多个目标物品（Target Object）达到相应的目标状态（Goal State）。机器人需要通过自己的行为实现语言指令。

比如在下面的这条指令中，一种有四个物体需要达到目标状态：
1. `toy bee` `on` `chair`
2. `toy food` `on` `chair`
3. `toy bee` `next to` `toy food`
4. `shoes` `on` `chest`
```
Help me clean up the bedroom. First, move the toy bee and one toy food to the bedroom chair, placing them next to each other. Then, put the shoes in the chest of drawers.
```


#### 3.1.1 任务目标限制 (Constraints)
任务指令中除了包含目标状态 (Goal State)，还有可能包含以下两个限制：
1. 时序限制 (Temporal Constraint): 任务要求物体按照顺序依次达到目标状态。
2. 多个指令内使用相同目标物体 (Same Argument Constraint): 任务要求达到描述的目标状态的过程，是由操作同一物体所完成的。
3. 终点满足限制 (Terminal Satisfaction Constraint): 一些物体，在作业结束后仍然处于目标状态。

在之前例子中，我们需达成四个目标状态
1. `toy bee` `on` `chair`
2. `toy food` `on` `chair`
3. `toy bee` `next to` `toy food`
4. `shoes` `on` `chest`
其中：
1. （1）、（2）、（3）都需要在达成（4）之前达成，这是Temporal Constraint。
2. （1）和（2）里面的`chair`需要是同一个家具，这是Same Argument Constraint。
3. 在结束时，仍然保持（1）、（2）、（3）和（4）的状态,这是Terminal Satisfaction Constraint。
```
Help me clean up the bedroom. First, move the toy bee and one toy food to the bedroom chair, placing them next to each other. Then, put the shoes in the chest of drawers.
```

### 3.2 场景初始状态
在场景创建时，物品将随机摆放在房屋内各家具内的区域中。

### 3.3 机器人感知局限
机器人的感知能力具有局部局限性。在任何时刻，机器人可以观测自己的位置、所有家具的摆放情况，但无法感知未探索区域内的物体摆放情况，只有通过探索房间内各家具，才可以获取物体信息。

### 3.4 机器人可执行动作与动作限制
在一个时间步，机器人可以执行一次动作（Action），并产生相应的结果。包括：

1. **导航 (Navigate):** 让机器人导航至目标节点旁，需要提供节点名称，可以是区域/家具/可操作区域/物体。比如(Navigate['counter_22'])。
2. **拾取 (Pick):** 让机器人拾起一个物体(Object)，需要提供被拾起物体的名称。比如(Pick['cup_1'])。
3. **放置 (Place):** 让机器人将手中物体 (Object)放在指定家具 (Furniture)上， 需要指定被放置物体的名称、目标家具名称、描述物体与家具关系的空间关系（"on"或"within"）。被放置物体必须已被代理持有（即先前已拾取）。此外，可要求将物体放置在另一个物体附近，此时需要可选提供空间约束（"next_to"）和参考物体名称。若需放置在物体旁，参考物体必须已位于目标家具上。API模板：Place[<被放置物体>, <空间关系>, <目标家具>, <空间约束>, <参考物体>]。若无需要，空间约束和参考物体应设为"None"。比如(Place['apple_1', 'with_in', "fridge_2', 'next_to', 'egg_3'])。
4. **打开 (Open):** 让机器人打开一个铰接家具 (Furniture)，需要提供被打开家具的名称。比如(Open['drawer_1'])。
5. **关闭 (Close):** 让机器人关闭一个铰接家具 (Furniture)，需要提供被关闭家具的名称。比如(Close['drawer_1'])。
6. **通电 (Power On):** 让机器人打开一个物体 (Object)或家具 (Furniture)的电源开关。比如(Power_on(['fridge_4']))
7. **断电 (Power Off):** 让机器人关闭一个物体 (Object)或家具 (Furniture)的电源开关。比如(Power_off(['fridge_4']))
8. **清洁 (Clean):** 让机器人清洁一个物体 (Object)或家具 (Furniture)。比如(Clean(['table_1']))。
9. **填充 (Fill):** 让机器人填充一个物体(Object)。比如(Fill(['kettle_1']))。
10. **倾倒 (Pour):** 让机器人将手中物体 (Object)向另一个容器倾倒。比如(Pour(['kettle_1']))。
11. **探索 (Explore):** 让机器人一个区域 (Region)节点内的各种可操作区域或家具来搜索该区域。需要提供区域名称，比如(Explore[‘living_room’])
12. **等待 (Wait):** 让机器人在原地等待

**注意:**
1. 机器人在执行拾取 (Pick)时手里不能有其他东西。
2. 在执行填充/倒出操作时，机器人需要手里有东西，且在有水龙头的家具旁边（详见Tutorials）。

## 4. 评测标准
最终评测将随机采样10项新任务要求机器人完成，每个任务有10分钟的执行时间。评测指标主要考量个维度：

### 4.1 任务成功率

#### 4.1.1 任务成功率

机器人成功完成任务的比例。机器人作业满足所有目标状态，则为任务成功。越高的任务成功率说明机器人的决策效率与质量越高。

#### 4.1.2 任务完成率
机器人任务内目标状态个数达成的平均比例，是衡量机器人决策效率和质量的另一指标。

### 4.2 任务执行时间
机器人执行任务所消耗的平均作业时间。任务作业时间为所有动作执行和推理思考时间的总和。越短的任务执行时间说明机器人决策越接近最优。

## 5. 解题思路

### 5.1 状态空间中的树搜索算法
可以将模拟器提供的类：世界图（World Graph）场景图视作世界状态，以马尔科夫决策过程（Markov Decision Procees）的视角理解决策问题，通过蒙特卡洛树搜索（Monte Carlo Tree Search）等方式，通过前瞻搜索与交互推演求解。

### 5.2 大模型推理

场景图内所有家具、区域与物体都有名字，比如“冰箱、橱柜、苹果”等。场景图可以文字的形式输入大语言模型，利用语义常识进行决策（比如找苹果应当先去开冰箱）。大模型与搜索的结合运用是很好的探索方向。

#### 5.2.1 大模型闭环推理
在任务规划领域中，闭环推理是建立观测与动作的映射函数，通常称为策略 (Policy)。大模型依据**当前**的观测，结合任务指令，通过常识性推理输出**下一步动作**，在环境中执行得到新的观测，然后重新推理，直至任务完成。

### 5.2.2 大模型闭环推理
开环推理是建立时间(time)与动作的映射函数，通常称为动作序列 (Action sequence)。大模型依据**初始**的观测，结合任务指令，通过常识性推理输出满足任务要求的**N步动作序列**，在环境中依次执行，有机会大幅度减小思考时间。

### 5.3 其他
检索增强生成（RAG）、小模型学习、强化学习、模仿学习、学习规划算法可以利用的子模块等，均是可能的解题思路。

**注意**：本题目中的决策问题相对于现实中的具身决策问题，进行了大量的简化，以保障适中的题目难度。因此，存在通过手动设计行为规则获取高分策略的可能。但我们主要评估的是解题者的系统性思维能力与科学研究能力，因此请专注于原则性算法的设计与开发。
